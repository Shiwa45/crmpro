{% extends 'base.html' %}

{% block title %}
    {% if object %}Edit{% else %}Create{% endif %} Email Template - CRM System
{% endblock %}

{% block page_title %}
    {% if object %}Edit{% else %}Create{% endif %} Email Template
{% endblock %}

{% block page_actions %}
<a href="{% url 'communications:template_list' %}" class="btn btn-secondary">
    <i class="bi bi-arrow-left"></i> Back to Templates
</a>
{% endblock %}

{% block content %}
<div class="row">
    <div class="col-lg-8">
        <div class="card">
            <div class="card-header">
                <h6 class="mb-0">Template Details</h6>
            </div>
            <div class="card-body">
                <form method="post">
                    {% csrf_token %}
                    
                    {% if form.errors %}
                        <div class="alert alert-danger">
                            {{ form.errors }}
                        </div>
                    {% endif %}
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="{{ form.name.id_for_label }}" class="form-label">Template Name *</label>
                                {{ form.name }}
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="{{ form.template_type.id_for_label }}" class="form-label">Template Type *</label>
                                {{ form.template_type }}
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="{{ form.subject.id_for_label }}" class="form-label">Email Subject *</label>
                        {{ form.subject }}
                    </div>
                    
                    <div class="mb-3">
                        <label for="{{ form.body_html.id_for_label }}" class="form-label">Email Content (HTML) *</label>
                        {{ form.body_html }}
                        <div class="form-text">{{ form.body_html.help_text|linebreaks }}</div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="{{ form.body_text.id_for_label }}" class="form-label">Plain Text Version</label>
                        {{ form.body_text }}
                        <div class="form-text">Optional plain text version for email clients that don't support HTML</div>
                    </div>
                    
                    <div class="mb-3 form-check">
                        {{ form.is_shared }}
                        <label class="form-check-label" for="{{ form.is_shared.id_for_label }}">
                            Share with Team
                        </label>
                        <div class="form-text">{{ form.is_shared.help_text }}</div>
                    </div>
                    
                    <div class="d-flex gap-2">
                        <button type="submit" class="btn btn-primary">
                            <i class="bi bi-check-circle"></i> 
                            {% if object %}Update{% else %}Create{% endif %} Template
                        </button>
                        <button type="button" class="btn btn-outline-secondary" onclick="previewTemplate()">
                            <i class="bi bi-eye"></i> Preview
                        </button>
                        <a href="{% url 'communications:template_list' %}" class="btn btn-secondary">Cancel</a>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <div class="col-lg-4">
        <div class="card">
            <div class="card-header">
                <h6 class="mb-0">Available Variables</h6>
            </div>
            <div class="card-body">
                <p class="small text-muted">Click to insert into your template:</p>
                <div class="variable-tags">
                    <span class="badge bg-light text-dark me-1 mb-1 variable-tag" onclick="insertVariable('{{lead_name}}')">{{lead_name}}</span>
                    <span class="badge bg-light text-dark me-1 mb-1 variable-tag" onclick="insertVariable('{{first_name}}')">{{first_name}}</span>
                    <span class="badge bg-light text-dark me-1 mb-1 variable-tag" onclick="insertVariable('{{last_name}}')">{{last_name}}</span>
                    <span class="badge bg-light text-dark me-1 mb-1 variable-tag" onclick="insertVariable('{{company}}')">{{company}}</span>
                    <span class="badge bg-light text-dark me-1 mb-1 variable-tag" onclick="insertVariable('{{email}}')">{{email}}</span>
                    <span class="badge bg-light text-dark me-1 mb-1 variable-tag" onclick="insertVariable('{{phone}}')">{{phone}}</span>
                    <span class="badge bg-light text-dark me-1 mb-1 variable-tag" onclick="insertVariable('{{user_name}}')">{{user_name}}</span>
                    <span class="badge bg-light text-dark me-1 mb-1 variable-tag" onclick="insertVariable('{{user_email}}')">{{user_email}}</span>
                    <span class="badge bg-light text-dark me-1 mb-1 variable-tag" onclick="insertVariable('{{current_date}}')">{{current_date}}</span>
                </div>
            </div>
        </div>
        
        <div class="card mt-4">
            <div class="card-header">
                <h6 class="mb-0">Template Tips</h6>
            </div>
            <div class="card-body">
                <ul class="small">
                    <li>Use variables to personalize your emails</li>
                    <li>Keep subject lines under 50 characters</li>
                    <li>Test your templates with preview</li>
                    <li>Use clear call-to-action buttons</li>
                    <li>Always include an unsubscribe option</li>
                </ul>
            </div>
        </div>
        
        <div class="card mt-4">
            <div class="card-header">
                <h6 class="mb-0">Quick Actions</h6>
            </div>
            <div class="card-body">
                <div class="d-grid gap-2">
                    <button type="button" class="btn btn-outline-primary btn-sm" onclick="insertTemplate('welcome')">
                        Insert Welcome Template
                    </button>
                    <button type="button" class="btn btn-outline-primary btn-sm" onclick="insertTemplate('followup')">
                        Insert Follow-up Template
                    </button>
                    <button type="button" class="btn btn-outline-primary btn-sm" onclick="insertTemplate('thankyou')">
                        Insert Thank You Template
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Preview Modal -->
<div class="modal fade" id="previewModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Template Preview</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="previewContent">
                    <!-- Preview content will be loaded here -->
                </div>
            </div>
        </div>
    </div>
</div>

<style>
.variable-tag {
    cursor: pointer;
    transition: all 0.2s;
}

.variable-tag:hover {
    background-color: #0d6efd !important;
    color: white !important;
}

.template-editor {
    min-height: 300px;
}
</style>

<script>
function insertVariable(variable) {
    const textarea = document.getElementById('id_body_html');
    const cursorPos = textarea.selectionStart;
    const textBefore = textarea.value.substring(0, cursorPos);
    const textAfter = textarea.value.substring(cursorPos);
    
    textarea.value = textBefore + variable + textAfter;
    textarea.focus();
    textarea.setSelectionRange(cursorPos + variable.length, cursorPos + variable.length);
}

function insertTemplate(type) {
    const subjectField = document.getElementById('id_subject');
    const bodyField = document.getElementById('id_body_html');
    
    const templates = {
        welcome: {
            subject: 'Welcome {{first_name}}! Let\'s get started',
            body: `<p>Hi {{first_name}},</p>

<p>Thank you for your interest in our services! I'm {{user_name}} and I'll be your point of contact.</p>

<p>I'd love to learn more about {{company}} and how we can help you achieve your goals.</p>

<p>Would you be available for a quick 15-minute call this week?</p>

<p>Looking forward to connecting with you!</p>

<p>Best regards,<br>
{{user_name}}<br>
{{user_email}}</p>`
        },
        followup: {
            subject: 'Following up on our conversation',
            body: `<p>Hi {{first_name}},</p>

<p>I wanted to follow up on our previous conversation about {{company}}'s needs.</p>

<p>Have you had a chance to review the information I sent? I'd be happy to answer any questions you might have.</p>

<p>If you'd like to move forward, we could schedule a more detailed discussion about your requirements.</p>

<p>Please let me know your thoughts!</p>

<p>Best regards,<br>
{{user_name}}<br>
{{user_email}}</p>`
        },
        thankyou: {
            subject: 'Thank you for your time, {{first_name}}',
            body: `<p>Hi {{first_name}},</p>

<p>Thank you for taking the time to speak with me today about {{company}}'s requirements.</p>

<p>As discussed, I'll be sending you a detailed proposal by the end of this week.</p>

<p>In the meantime, if you have any questions or need additional information, please don't hesitate to reach out.</p>

<p>I look forward to the opportunity to work with {{company}}!</p>

<p>Best regards,<br>
{{user_name}}<br>
{{user_email}}</p>`
        }
    };
    
    if (templates[type]) {
        if (confirm('This will replace the current content. Continue?')) {
            subjectField.value = templates[type].subject;
            bodyField.value = templates[type].body;
        }
    }
}

function previewTemplate() {
    const subject = document.getElementById('id_subject').value;
    const body = document.getElementById('id_body_html').value;
    
    if (!subject && !body) {
        alert('Please enter some content to preview.');
        return;
    }
    
    // Replace variables with sample data for preview
    const sampleData = {
        '{{lead_name}}': 'John Doe',
        '{{first_name}}': 'John',
        '{{last_name}}': 'Doe',
        '{{company}}': 'Sample Company',
        '{{email}}': 'john.doe@example.com',
        '{{phone}}': '+1 555-0123',
        '{{user_name}}': '{{ user.get_full_name }}',
        '{{user_email}}': '{{ user.email }}',
        '{{current_date}}': new Date().toLocaleDateString('en-US', {
            year: 'numeric',
            month: 'long',
            day: 'numeric'
        })
    };
    
    let previewSubject = subject;
    let previewBody = body;
    
    Object.keys(sampleData).forEach(variable => {
        const regex = new RegExp(variable.replace(/[{}]/g, '\\$&'), 'g');
        previewSubject = previewSubject.replace(regex, sampleData[variable]);
        previewBody = previewBody.replace(regex, sampleData[variable]);
    });
    
    document.getElementById('previewContent').innerHTML = `
        <div class="mb-3">
            <strong>Subject:</strong> ${previewSubject}
        </div>
        <div class="border rounded p-3" style="background-color: #f8f9fa;">
            ${previewBody}
        </div>
        <div class="mt-3">
            <small class="text-muted">
                <i class="bi bi-info-circle"></i> 
                This is a preview with sample data. Actual emails will use real lead information.
            </small>
        </div>
    `;
    
    const modal = new bootstrap.Modal(document.getElementById('previewModal'));
    modal.show();
}

// Auto-save functionality (optional)
let autoSaveTimer;
function setupAutoSave() {
    const fields = ['id_subject', 'id_body_html', 'id_body_text'];
    
    fields.forEach(fieldId => {
        const field = document.getElementById(fieldId);
        if (field) {
            field.addEventListener('input', function() {
                clearTimeout(autoSaveTimer);
                autoSaveTimer = setTimeout(() => {
                    // Save to localStorage as backup
                    localStorage.setItem('template_backup_' + fieldId, field.value);
                }, 2000);
            });
        }
    });
}

document.addEventListener('DOMContentLoaded', function() {
    setupAutoSave();
    
    // Restore from localStorage if available
    const fields = ['id_subject', 'id_body_html', 'id_body_text'];
    fields.forEach(fieldId => {
        const field = document.getElementById(fieldId);
        const backup = localStorage.getItem('template_backup_' + fieldId);
        if (field && backup && !field.value) {
            field.value = backup;
        }
    });
});

// Clear backup on successful save
document.querySelector('form').addEventListener('submit', function() {
    const fields = ['id_subject', 'id_body_html', 'id_body_text'];
    fields.forEach(fieldId => {
        localStorage.removeItem('template_backup_' + fieldId);
    });
});
</script>
{% endblock %}
